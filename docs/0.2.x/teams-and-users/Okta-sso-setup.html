<h1 id="setup-okta-with-qordoba-saml-sso">Setup Okta with Qordoba SAML SSO</h1>

<p>You can make an API proxied by Qordoba use a <a href="/docs//loadbalancing#ring-balancer">ring-balancer</a>, configured
by adding an <a href="/docs//loadbalancing#upstream">upstream</a> entity that contains one or more <a href="/docs//loadbalancing#target">target</a>
entities, each target pointing to a different IP address (or hostname) and
port. The ring-balancer will balance load among the various targets, and based
on the <a href="/docs//loadbalancing#upstream">upstream</a> configuration, will perform health checks on the targets,
making them as healthy or unhealthy whether they are responsive or not. The
ring-balancer will then only route traffic to healthy targets.</p>

<p>Qordoba supports two kinds of health checks, which can be used separately or in
conjunction:</p>

<ul>
  <li>
    <p><strong>active checks</strong>, where a specific HTTP endpoint in the target is
periodically requested and the health of the target is determined based on its
response;</p>
  </li>
  <li>
    <p><strong>passive checks</strong> (also known as <strong>circuit breakers</strong>), where Qordoba analyzes
the ongoing traffic being proxied and determines the health of targets based
on their behavior responding requests.</p>
  </li>
</ul>

<h3 id="table-of-contents">Table of Contents</h3>

<ul>
  <li><a href="#healthy-and-unhealthy-targets">Healthy and unhealthy targets</a></li>
  <li><a href="#types-of-health-checks">Types of health checks</a>
    <ul>
      <li><a href="#active-health-checks">Active health checks</a></li>
      <li><a href="#passive-health-checks-circuit-breakers">Passive health checks (circuit breakers)</a></li>
      <li><a href="#summary-of-pros-and-cons">Summary of pros and cons</a></li>
    </ul>
  </li>
  <li><a href="#enabling-and-disabling-health-checks">Enabling and disabling health checks</a>
    <ul>
      <li><a href="#enabling-active-health-checks">Enabling active health checks</a></li>
      <li><a href="#enabling-active-health-checks">Enabling active health checks</a></li>
      <li><a href="#disabling-health-checks">Disabling health checks</a></li>
    </ul>
  </li>
</ul>

<h3 id="healthy-and-unhealthy-targets">Healthy and unhealthy targets</h3>

<p>The objective of the health checks functionality is to dynamically mark
targets as healthy or unhealthy, <strong>for a given Qordoba node</strong>. There is
no cluster-wide synchronization of health information: each Qordoba node
determines the health of its targets separately. This is desirable since at a
given point one Qordoba node may be able to connect to a target successfully
while another node is failing to reach it: the first node will consider
it healthy, while the second will mark it as unhealthy and start routing
traffic to other targets of the upstream.</p>

<p>Either an active probe (on active health checks) or a proxied request
(on passive health checks) produces data which is used to determine
whether a target is healthy or unhealthy. A request may produce a TCP
error, timeout, or produce an HTTP status code. Based on this
information, the health checker updates a series of internal counters:</p>

<ul>
  <li>If the returned status code is one configured as “healthy”, it will
increment the “Successes” counter for the target and clear all its other
counters;</li>
  <li>If it fails to connect, it will increment the “TCP failures” counter
for the target and clear the “Successes” counter;</li>
  <li>If it times out, it will increment the “timeouts” counter
for the target and clear the “Successes” counter;</li>
  <li>If the returned status code is one configured as “unhealthy”, it will
increment the “HTTP failures” counter for the target and clear the “Successes” counter.</li>
</ul>

<p>If any of the “TCP failures”, “HTTP failures” or “timeouts” counters reaches
their configured threshold, the target will be marked as unhealthy.</p>

<p>If the “Sucesses” counter reaches its configured threshold, the target will be
marked as healthy.</p>

<p>The list of which HTTP status codes are “healthy” or “unhealthy”, and the
individual thresholds for each of these counters are configurable on a
per-upstream basis. Below, we have an example of a configuration for an
Upstream entity, showcasing the default values of the various fields
available for configuring health checks. A description of each
field is included in the <a href="/docs//admin-api#add-upstream">Admin API</a> reference documentation.</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"service.v1.xyz"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"healthchecks"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"active"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"concurrency"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w">
            </span><span class="nt">"healthy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nt">"http_statuses"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">302</span><span class="w"> </span><span class="p">],</span><span class="w">
                </span><span class="nt">"interval"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="nt">"successes"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nt">"http_path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"timeout"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nt">"unhealthy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nt">"http_failures"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="nt">"http_statuses"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">429</span><span class="p">,</span><span class="w"> </span><span class="mi">404</span><span class="p">,</span><span class="w"> </span><span class="mi">500</span><span class="p">,</span><span class="w"> </span><span class="mi">501</span><span class="p">,</span><span class="w">
                                   </span><span class="mi">502</span><span class="p">,</span><span class="w"> </span><span class="mi">503</span><span class="p">,</span><span class="w"> </span><span class="mi">504</span><span class="p">,</span><span class="w"> </span><span class="mi">505</span><span class="w"> </span><span class="p">],</span><span class="w">
                </span><span class="nt">"interval"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="nt">"tcp_failures"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="nt">"timeouts"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nt">"passive"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"healthy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nt">"http_statuses"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">201</span><span class="p">,</span><span class="w"> </span><span class="mi">202</span><span class="p">,</span><span class="w"> </span><span class="mi">203</span><span class="p">,</span><span class="w">
                                   </span><span class="mi">204</span><span class="p">,</span><span class="w"> </span><span class="mi">205</span><span class="p">,</span><span class="w"> </span><span class="mi">206</span><span class="p">,</span><span class="w"> </span><span class="mi">207</span><span class="p">,</span><span class="w">
                                   </span><span class="mi">208</span><span class="p">,</span><span class="w"> </span><span class="mi">226</span><span class="p">,</span><span class="w"> </span><span class="mi">300</span><span class="p">,</span><span class="w"> </span><span class="mi">301</span><span class="p">,</span><span class="w">
                                   </span><span class="mi">302</span><span class="p">,</span><span class="w"> </span><span class="mi">303</span><span class="p">,</span><span class="w"> </span><span class="mi">304</span><span class="p">,</span><span class="w"> </span><span class="mi">305</span><span class="p">,</span><span class="w">
                                   </span><span class="mi">306</span><span class="p">,</span><span class="w"> </span><span class="mi">307</span><span class="p">,</span><span class="w"> </span><span class="mi">308</span><span class="w"> </span><span class="p">],</span><span class="w">
                </span><span class="nt">"successes"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nt">"unhealthy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nt">"http_failures"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="nt">"http_statuses"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">429</span><span class="p">,</span><span class="w"> </span><span class="mi">500</span><span class="p">,</span><span class="w"> </span><span class="mi">503</span><span class="w"> </span><span class="p">],</span><span class="w">
                </span><span class="nt">"tcp_failures"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="nt">"timeouts"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nt">"slots"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>If all targets of an upstream are unhealthy, Qordoba will respond to requests
to the upstream with <code class="highlighter-rouge">503 Service Unavailable</code>.</p>

<p>Note:</p>

<ol>
  <li>health checks operate only on <a href="/docs//admin-api#target-object"><em>active</em> targets</a> and do not
modify the <em>active</em> status of a target in the Qordoba database.</li>
  <li>unhealthy targets will not be removed from the loadbalancer, and hence will
not have any impact on the balancer layout when using the hashing algorithm
(they will just be skipped).</li>
  <li>The <a href="/docs//loadbalancing#dns-caveats">DNS caveats</a> and <a href="/docs//loadbalancing#balancing-caveats">balancer caveats</a>
also apply to health checks. If using hostnames for the targets, then make
sure the DNS server always returns the full set of IP addresses for a name,
and does not limit the response. <em>Failing to do so might lead to health
checks not being executed.</em></li>
</ol>

<h3 id="types-of-health-checks">Types of health checks</h3>

<h4 id="active-health-checks">Active health checks</h4>

<p>Active health checks, as the name implies, actively probe targets for
their health. When active health checks are enabled in an upstream entity,
Qordoba will periodically issue HTTP requests to a configured path at each target
of the upstream. This allows Qordoba to automatically enable and disable targets
in the balancer based on the <a href="#healthy-and-unhealthy-targets">probe results</a>.</p>

<p>The periodicity of active health checks can be configured separately for
when a target is healthy or unhealthy. If the <code class="highlighter-rouge">interval</code> value for either
is set to zero, the checking is disabled at the corresponding scenario.
When both are zero, active health checks are disabled altogether.</p>

<p><a href="#table-of-contents">Back to TOC</a></p>

<h4 id="passive-health-checks-circuit-breakers">Passive health checks (circuit breakers)</h4>

<p>Passive health checks, also known as circuit breakers, are
checks performed based on the requests being proxied by Qordoba,
with no additional traffic being generated. When a target becomes
unresponsive, the passive health checker will detect that and mark
the target as unhealthy. The ring-balancer will start skipping this
target, so no more traffic will be routed to it.</p>

<p>Once the problem with a target is solved and it is ready to receive
traffic again, the Qordoba administrator can manually inform the
health checker that the target should be enabled again, via an
Admin API endpoint:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -i -X POST http://localhost:8001/upstream/my_upstream/targets/10.1.2.3:1234/healthy
HTTP/1.1 204 No Content
</code></pre>
</div>

<p>This command will broadcast a cluster-wide message so that the “healthy”
status is propagated to the whole <a href="/docs//clustering">Qordoba cluster</a>. This will cause Qordoba nodes to
reset the health counters of the health checkers running in all workers of the
Qordoba node, allowing the ring-balancer to route traffic to the target again.</p>

<p>Passive health checks have the advantage of not producing extra
traffic, but they are unable to automatically mark a target as
healthy again: the “circuit is broken”, and the target needs to
be re-enabled again by the system administrator.</p>

<p><a href="#table-of-contents">Back to TOC</a></p>

<h4 id="summary-of-pros-and-cons">Summary of pros and cons</h4>

<ul>
  <li>Active health checks can automatically re-enable a target in the
ring balancer as soon as it is healthy again. Passive health checks cannot.</li>
  <li>Passive health checks do not produce additional traffic to the 
target. Active health checks do.</li>
  <li>An active health checker demands a known URL with a reliable status response
in the target to be configured as a probe endpoint (which may be as
simple as <code class="highlighter-rouge">"/"</code>). Passive health checks do not demand such configuration.</li>
  <li>By providing a custom probe endpoint for an active health checker,
an application may determine its own health metrics and produce a status
code to be consumed by Qordoba. Even though a target continues to serve
traffic which looks healthy to the passive health checker,
it would be able to respond to the active probe with a failure
status, essentially requesting to be relieved from taking new traffic.</li>
</ul>

<p>It is possible to combine the two modes. For example, one can enable
passive health checks to monitor the target health based solely on its
traffic, and only use active health checks while the target is unhealthy,
in order to re-enable it automatically.</p>

<h3 id="enabling-and-disabling-health-checks">Enabling and disabling health checks</h3>

<h4 id="enabling-active-health-checks">Enabling active health checks</h4>

<p>To enable active health checks, you need to specify the configuration items
under <code class="highlighter-rouge">healthchecks.active</code> in the <a href="/docs//admin-api#upstream-objects">Upstream object</a> configuration. You
need to specify the necessary information so that Qordoba can perform periodic
probing on the target, and how to interpret the resulting information.</p>

<p>For configuring the probe, you need to specify:</p>

<ul>
  <li><code class="highlighter-rouge">healthchecks.active.http_path</code> - The path that should be used when
issuing the HTTP GET request to the target. The default value is <code class="highlighter-rouge">"/"</code>.</li>
  <li><code class="highlighter-rouge">healthchecks.active.timeout</code> - The connection timeout limit for the
HTTP GET request of the probe. The default value is 1 second.</li>
  <li><code class="highlighter-rouge">healthchecks.active.concurrency</code> - The connection timeout limit for the
HTTP GET request of the probe. The default value is 1 second.</li>
</ul>

<p>You also need to specify positive values for intervals, for running
probes:</p>

<ul>
  <li><code class="highlighter-rouge">healthchecks.active.healthy.interval</code> - Interval between active health
checks for healthy targets (in seconds). A value of zero indicates that active
probes for healthy targets should not be performed.</li>
  <li><code class="highlighter-rouge">healthchecks.active.unhealthy.interval</code> - Interval between active health
checks for unhealthy targets (in seconds). A value of zero indicates that active
probes for unhealthy targets should not be performed.</li>
</ul>

<p>This allows you to tune the behavior of the active health checks, whether you
want probes for healthy and unhealthy targets to run at the same interval, or
one to be more frequent than the other.</p>

<p>Finally, you need to configure how Qordoba should interpret the probe, by setting
the various thresholds on the <a href="#healthy-and-unhealthy-targets">health
counters</a>, which, once reached will trigger a
status change. The counter threshold fields are:</p>

<ul>
  <li><code class="highlighter-rouge">healthchecks.active.healthy.successes</code> - Number of successes in active
probes (as defined by <code class="highlighter-rouge">healthchecks.active.healthy.http_statuses</code>) to consider
a target healthy.</li>
  <li><code class="highlighter-rouge">healthchecks.active.unhealthy.tcp_failures</code> - Number of TCP failures in
active probes to consider a target unhealthy.</li>
  <li><code class="highlighter-rouge">healthchecks.active.unhealthy.timeouts</code> - Number of timeouts in active
probes to consider a target unhealthy.</li>
  <li><code class="highlighter-rouge">healthchecks.active.unhealthy.http_failures</code> - Number of HTTP failures in
active probes (as defined by <code class="highlighter-rouge">healthchecks.active.unhealthy.http_statuses</code>) to
consider a target unhealthy.</li>
</ul>

<h4 id="enabling-passive-health-checks">Enabling passive health checks</h4>

<p>Passive health checks do not feature a probe, as they work by interpreting
the ongoing traffic that flows from a target. This means that to enable
passive checks you only need to configure its counter thresholds:</p>

<ul>
  <li><code class="highlighter-rouge">healthchecks.passive.healthy.successes</code> - Number of successes in proxied
traffic (as defined by <code class="highlighter-rouge">healthchecks.passive.healthy.http_statuses</code>) to
consider a target healthy, as observed by passive health checks. This needs to
be positive when passive checks are enabled so that healthy traffic resets the
unhealthy counters.</li>
  <li><code class="highlighter-rouge">healthchecks.passive.unhealthy.tcp_failures</code> - Number of TCP failures in
proxied traffic to consider a target unhealthy, as observed by passive health
checks.</li>
  <li><code class="highlighter-rouge">healthchecks.passive.unhealthy.timeouts</code> - Number of timeouts in proxied
traffic to consider a target unhealthy, as observed by passive health checks.</li>
  <li><code class="highlighter-rouge">healthchecks.passive.unhealthy.http_failures</code> - Number of HTTP failures in
proxied traffic (as defined by <code class="highlighter-rouge">healthchecks.passive.unhealthy.http_statuses</code>)
to consider a target unhealthy, as observed by passive health checks.</li>
</ul>

<h4 id="disabling-health-checks">Disabling health checks</h4>

<p>In all counter thresholds and intervals specified in the <code class="highlighter-rouge">healthchecks</code>
configuration, setting a value to zero means that the functionality the field
represents is disabled. Setting a probe interval to zero disables a probe.
Likewise, you can disable certain types of checks by setting their counter
thresholds to zero. For example, to not consider timeouts when performing
healthchecks, you can set both <code class="highlighter-rouge">timeouts</code> fields (for active and passive
checks) to zero. This gives you a fine-grained control of the behavior of the
health checker.</p>

<p>In summary, to completely disable active health checks for an upstream, you
need to set both <code class="highlighter-rouge">healthchecks.active.healthy.interval</code> and
<code class="highlighter-rouge">healthchecks.active.unhealthy.interval</code> to <code class="highlighter-rouge">0</code>.</p>

<p>To completely disable passive health checks, you need to set all counter
thresholds under <code class="highlighter-rouge">healthchecks.passive</code> for its various counters to zero.</p>

<p>All counter thresholds and intervals in <code class="highlighter-rouge">healthchecks</code> are zero by default,
meaning that health checks are completely disabled by default in newly created
upstreams.</p>

<p><a href="#table-of-contents">Back to TOC</a></p>

