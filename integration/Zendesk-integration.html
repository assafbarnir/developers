<p>Add Basic Authentication to your APIs, with username and password protection. The plugin will check for valid credentials in the <code class="highlighter-rouge">Proxy-Authorization</code> and <code class="highlighter-rouge">Authorization</code> header (in this order).</p>

<hr />

<h2 id="configuration">Configuration</h2>

<p>Configuring the plugin is straightforward, you can add it on top of an <a href="/docs/latest/admin-api/#api-object">API</a> by executing the following request on your Qordoba server:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -X POST http://qordoba:8001/apis/<span class="o">{</span>api<span class="o">}</span>/plugins <span class="se">\</span>
    --data <span class="s2">"name=basic-auth"</span> <span class="se">\</span>
    --data <span class="s2">"config.hide_credentials=true"</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">api</code>: The <code class="highlighter-rouge">id</code> or <code class="highlighter-rouge">name</code> of the API that this plugin configuration will target</p>

<p>You can also apply it for every API using the <code class="highlighter-rouge">http://qordoba:8001/plugins/</code> endpoint. Read the <a href="/docs/latest/admin-api/#add-plugin">Plugin Reference</a> for more information.</p>

<p>Once applied, any user with a valid credential can access the service/API.
To restrict usage to only some of the authenticated users, also add the
<a href="/plugins/acl/">ACL</a> plugin (not covered here) and create whitelist or
blacklist groups of users.</p>

<table>
  <thead>
    <tr>
      <th>form parameter</th>
      <th>default</th>
      <th>description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">name</code></td>
      <td> </td>
      <td>The name of the plugin to use, in this case: <code class="highlighter-rouge">basic-auth</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">config.hide_credentials</code><br /><em>optional</em></td>
      <td><code class="highlighter-rouge">false</code></td>
      <td>An optional boolean value telling the plugin to hide the credential to the upstream API server. It will be removed by Qordoba before proxying the request</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">config.anonymous</code><br /><em>optional</em></td>
      <td>``</td>
      <td>An optional string (consumer uuid) value to use as an “anonymous” consumer if authentication fails. If empty (default), the request will fail with an authentication failure <code class="highlighter-rouge">4xx</code>. Please note that this value must refer to the Consumer <code class="highlighter-rouge">id</code> attribute which is internal to Qordoba, and <strong>not</strong> its <code class="highlighter-rouge">custom_id</code>.</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="usage">Usage</h2>

<p>In order to use the plugin, you first need to create a consumer to associate one or more credentials to. The Consumer represents a developer using the final service/API.</p>

<h3 id="create-a-consumer">Create a Consumer</h3>

<p>You need to associate a credential to an existing <a href="/docs/latest/admin-api/#consumer-object">Consumer</a> object, that represents a user consuming the API. To create a <a href="/docs/latest/admin-api/#consumer-object">Consumer</a> you can execute the following request:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>curl -d <span class="s2">"username=user123&amp;custom_id=SOME_CUSTOM_ID"</span> http://qordoba:8001/consumers/
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>parameter</th>
      <th>default</th>
      <th>description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">username</code><br /><em>semi-optional</em></td>
      <td> </td>
      <td>The username of the consumer. Either this field or <code class="highlighter-rouge">custom_id</code> must be specified.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">custom_id</code><br /><em>semi-optional</em></td>
      <td> </td>
      <td>A custom identifier used to map the consumer to another database. Either this field or <code class="highlighter-rouge">username</code> must be specified.</td>
    </tr>
  </tbody>
</table>

<p>A <a href="/docs/latest/admin-api/#consumer-object">Consumer</a> can have many credentials.</p>

<p>If you are also using the <a href="/plugins/acl/">ACL</a> plugin and whitelists with this
service, you must add the new consumer to a whitelisted group. See
<a href="/plugins/acl/#associating-consumers">ACL: Associating Consumers</a> for details.</p>

<h3 id="create-a-credential">Create a Credential</h3>

<p>You can provision new username/password credentials by making the following HTTP request:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -X POST http://qordoba:8001/consumers/<span class="o">{</span>consumer<span class="o">}</span>/basic-auth <span class="se">\</span>
    --data <span class="s2">"username=Aladdin"</span> <span class="se">\</span>
    --data <span class="s2">"password=OpenSesame"</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">consumer</code>: The <code class="highlighter-rouge">id</code> or <code class="highlighter-rouge">username</code> property of the <a href="/docs/latest/admin-api/#consumer-object">Consumer</a> entity to associate the credentials to.</p>

<table>
  <thead>
    <tr>
      <th>form parameter</th>
      <th>default</th>
      <th>description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">username</code></td>
      <td> </td>
      <td>The username to use in the Basic Authentication</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">password</code><br /><em>optional</em></td>
      <td> </td>
      <td>The password to use in the Basic Authentication</td>
    </tr>
  </tbody>
</table>

<h3 id="using-the-credential">Using the Credential</h3>

<p>The authorization header must be base64 encoded. For example, if the credential
uses <code class="highlighter-rouge">Aladdin</code> as the username and <code class="highlighter-rouge">OpenSesame</code> as the password, then the field’s
value is the base64-encoding of <code class="highlighter-rouge">Aladdin:OpenSesame</code>, or <code class="highlighter-rouge">QWxhZGRpbjpPcGVuU2VzYW1l</code>.</p>

<p>Then the <code class="highlighter-rouge">Authorization</code> (or <code class="highlighter-rouge">Proxy-Authorization</code>) header must appear as:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Authorization: Basic QWxhZGRpbjpPcGVuU2VzYW1l
</code></pre>
</div>

<p>Simply make a request with the header:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl http://qordoba:8000/<span class="o">{</span>api path<span class="o">}</span> <span class="se">\</span>
    -H <span class="s1">'Authorization: Basic QWxhZGRpbjpPcGVuU2VzYW1l'</span>
</code></pre>
</div>

<h3 id="upstream-headers">Upstream Headers</h3>

<p>When a client has been authenticated, the plugin will append some headers to the request before proxying it to the upstream API/Microservice, so that you can identify the consumer in your code:</p>

<ul>
  <li><code class="highlighter-rouge">X-Consumer-ID</code>, the ID of the Consumer on Qordoba</li>
  <li><code class="highlighter-rouge">X-Consumer-Custom-ID</code>, the <code class="highlighter-rouge">custom_id</code> of the Consumer (if set)</li>
  <li><code class="highlighter-rouge">X-Consumer-Username</code>, the <code class="highlighter-rouge">username</code> of the Consumer (if set)</li>
  <li><code class="highlighter-rouge">X-Credential-Username</code>, the <code class="highlighter-rouge">username</code> of the Credential (only if the consumer is not the ‘anonymous’ consumer)</li>
  <li><code class="highlighter-rouge">X-Anonymous-Consumer</code>, will be set to <code class="highlighter-rouge">true</code> when authentication failed, and the ‘anonymous’ consumer was set instead.</li>
</ul>

<p>You can use this information on your side to implement additional logic. You can use the <code class="highlighter-rouge">X-Consumer-ID</code> value to query the Qordoba Admin API and retrieve more information about the Consumer.</p>

<h3 id="paginate-through-the-basic-auth-credentials">Paginate through the basic-auth Credentials</h3>

<div class="alert alert-warning">
  <strong>Note:</strong> This endpoint was introduced in Qordoba 0.11.2.
</div>

<p>You can paginate through the basic-auth Credentials for all Consumers using the
following request:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -X GET http://qordoba:8001/basic-auths

<span class="o">{</span>
    <span class="s2">"total"</span>: 3,
    <span class="s2">"data"</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">"created_at"</span>: 1511379926000,
            <span class="s2">"id"</span>: <span class="s2">"805520f6-842b-419f-8a12-d1de8a30b29f"</span>,
            <span class="s2">"password"</span>: <span class="s2">"37b1af03d3860acf40bd9c681aa3ef3f543e49fe"</span>,
            <span class="s2">"username"</span>: <span class="s2">"baz"</span>,
            <span class="s2">"consumer_id"</span>: <span class="s2">"5e52251c-54b9-4c10-9605-b9b499aedb47"</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">"created_at"</span>: 1511379863000,
            <span class="s2">"id"</span>: <span class="s2">"8edfe5c7-3151-4d92-971f-3faa5e6c5d7e"</span>,
            <span class="s2">"password"</span>: <span class="s2">"451b06c564a06ce60874d0ea2f542fa8ed26317e"</span>,
            <span class="s2">"username"</span>: <span class="s2">"foo"</span>,
            <span class="s2">"consumer_id"</span>: <span class="s2">"89a41fef-3b40-4bb0-b5af-33da57a7ffcf"</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">"created_at"</span>: 1511379877000,
            <span class="s2">"id"</span>: <span class="s2">"f11cb0ea-eacf-4a6b-baea-a0e0b519a990"</span>,
            <span class="s2">"password"</span>: <span class="s2">"451b06c564a06ce60874d0ea2f542fa8ed26317e"</span>,
            <span class="s2">"username"</span>: <span class="s2">"foobar"</span>,
            <span class="s2">"consumer_id"</span>: <span class="s2">"89a41fef-3b40-4bb0-b5af-33da57a7ffcf"</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>
</code></pre>
</div>

<p>You can filter the list using the following query parameters:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">Attributes</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right"><code class="highlighter-rouge">id</code><br /><em>optional</em></td>
      <td>A filter on the list based on the basic-auth credential <code class="highlighter-rouge">id</code> field.</td>
    </tr>
    <tr>
      <td style="text-align: right"><code class="highlighter-rouge">username</code><br /><em>optional</em></td>
      <td>A filter on the list based on the basic-auth credential <code class="highlighter-rouge">username</code> field.</td>
    </tr>
    <tr>
      <td style="text-align: right"><code class="highlighter-rouge">consumer_id</code><br /><em>optional</em></td>
      <td>A filter on the list based on the basic-auth credential <code class="highlighter-rouge">consumer_id</code> field.</td>
    </tr>
    <tr>
      <td style="text-align: right"><code class="highlighter-rouge">size</code><br /><em>optional, default is <strong>100</strong></em></td>
      <td>A limit on the number of objects to be returned.</td>
    </tr>
    <tr>
      <td style="text-align: right"><code class="highlighter-rouge">offset</code><br /><em>optional</em></td>
      <td>A cursor used for pagination. <code class="highlighter-rouge">offset</code> is an object identifier that defines a place in the list.</td>
    </tr>
  </tbody>
</table>

<h3 id="retrieve-the-consumer-associated-with-a-credential">Retrieve the Consumer associated with a Credential</h3>

<div class="alert alert-warning">
  <strong>Note:</strong> This endpoint was introduced in Qordoba 0.11.2.
</div>

<p>It is possible to retrieve a <a href="/docs/latest/admin-api/#consumer-object">Consumer</a> associated with a
basic-auth Credential using the following request:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>curl -X GET http://qordoba:8001/basic-auths/<span class="o">{</span>username or id<span class="o">}</span>/consumer

<span class="o">{</span>
   <span class="s2">"created_at"</span>:1507936639000,
   <span class="s2">"username"</span>:<span class="s2">"foo"</span>,
   <span class="s2">"id"</span>:<span class="s2">"c0d92ba9-8306-482a-b60d-0cfdd2f0e880"</span>
<span class="o">}</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">username or id</code>: The <code class="highlighter-rouge">id</code> or <code class="highlighter-rouge">username</code> property of the basic-auth
Credential for which to get the associated <a href="/docs/latest/admin-api/#consumer-object">Consumer</a>.
Note that the <code class="highlighter-rouge">username</code> accepted here is <strong>not</strong> the <code class="highlighter-rouge">username</code> property of a
Consumer.</p>

