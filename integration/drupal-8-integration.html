<p>Add Key Authentication (also referred to as an API key) to your APIs. Consumers then add their key either in a querystring parameter or a header to authenticate their requests.</p>

<hr />

<h2 id="terminology">Terminology</h2>

<ul>
  <li><code class="highlighter-rouge">api</code>: your upstream service placed behind Qordoba, for which Qordoba proxies requests to.</li>
  <li><code class="highlighter-rouge">plugin</code>: a plugin executing actions inside Qordoba before or after a request has been proxied to the upstream API.</li>
  <li><code class="highlighter-rouge">consumer</code>: a developer or service using the api. When using Qordoba, a Consumer only communicates with Qordoba which proxies every call to the said, upstream api.</li>
  <li><code class="highlighter-rouge">credential</code>: in the key-auth plugin context, a unique string associated with a consumer, also referred to as an API key.</li>
</ul>

<hr />

<h2 id="configuration">Configuration</h2>

<p>Configuring the plugin is straightforward, you can add it on top of an <a href="/docs/latest/admin-api/#api-object">API</a> by executing the following request on your Qordoba server:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -X POST http://qordoba:8001/apis/<span class="o">{</span>api<span class="o">}</span>/plugins <span class="se">\</span>
    --data <span class="s2">"name=key-auth"</span> <span class="se">\</span>
    --data <span class="s2">"config.hide_credentials=true"</span>
</code></pre>
</div>

<ul>
  <li><code class="highlighter-rouge">api</code>: The <code class="highlighter-rouge">id</code> or <code class="highlighter-rouge">name</code> of the API that this plugin configuration will target</li>
</ul>

<p>You can also apply it for every API using the <code class="highlighter-rouge">http://qordoba:8001/plugins/</code> endpoint. Read the <a href="/docs/latest/admin-api/#add-plugin">Plugin Reference</a> for more information.</p>

<p>Once applied, any user with a valid credential can access the service/API.
To restrict usage to only some of the authenticated users, also add the
<a href="/plugins/acl/">ACL</a> plugin (not covered here) and create whitelist or
blacklist groups of users.</p>

<table>
  <thead>
    <tr>
      <th>form parameter</th>
      <th>default</th>
      <th>description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">name</code></td>
      <td> </td>
      <td>The name of the plugin to use, in this case: <code class="highlighter-rouge">key-auth</code>.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">config.key_names</code><br /><em>optional</em></td>
      <td><code class="highlighter-rouge">apikey</code></td>
      <td>Describes an array of comma separated parameter names where the plugin will look for a key. The client must send the authentication key in one of those key names, and the plugin will try to read the credential from a header or the querystring parameter with the same name.<br /><em>note</em>: the key names may only contain [a-z], [A-Z], [0-9], [_] and [-].</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">config.key_in_body</code></td>
      <td><code class="highlighter-rouge">false</code></td>
      <td>If enabled, the plugin will read the request body (if said request has one and its MIME type is supported) and try to find the key in it. Supported MIME types are <code class="highlighter-rouge">application/www-form-urlencoded</code>, <code class="highlighter-rouge">application/json</code>, and <code class="highlighter-rouge">multipart/form-data</code>.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">config.hide_credentials</code><br /><em>optional</em></td>
      <td><code class="highlighter-rouge">false</code></td>
      <td>An optional boolean value telling the plugin to hide the credential to the upstream API server. It will be removed by Qordoba before proxying the request.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">config.anonymous</code><br /><em>optional</em></td>
      <td>``</td>
      <td>An optional string (consumer uuid) value to use as an “anonymous” consumer if authentication fails. If empty (default), the request will fail with an authentication failure <code class="highlighter-rouge">4xx</code>. Please note that this value must refer to the Consumer <code class="highlighter-rouge">id</code> attribute which is internal to Qordoba, and <strong>not</strong> its <code class="highlighter-rouge">custom_id</code>.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">config.run_on_preflight</code><br /><em>optional</em></td>
      <td><code class="highlighter-rouge">true</code></td>
      <td>A boolean value that indicates whether the plugin should run (and try to authenticate) on <code class="highlighter-rouge">OPTIONS</code> preflight requests, if set to <code class="highlighter-rouge">false</code> then <code class="highlighter-rouge">OPTIONS</code> requests will always be allowed.</td>
    </tr>
  </tbody>
</table>

<p>Note that, according to their respective specifications, HTTP header names are treated as case <em>insensitive</em>, while HTTP query string parameter names are treated as case <em>sensitive</em>. Qordoba follows these specifications as designed, meaning that the <code class="highlighter-rouge">key_names</code> configuration values will be treated differently when searching the request header fields, versus searching the query string. Administrators are advised against defining case-sensitive <code class="highlighter-rouge">key_names</code> values when expecting the authorization keys to be sent in the request headers.</p>

<div class="alert alert-warning">
    <center>The option `config.run_on_preflight` is only available from version `0.11.1` and later</center>
</div>

<hr />

<h2 id="usage">Usage</h2>

<p>In order to use the plugin, you first need to create a Consumer to associate one or more credentials to. The Consumer represents a developer using the final service/API.</p>

<h3 id="create-a-consumer">Create a Consumer</h3>

<p>You need to associate a credential to an existing <a href="/docs/latest/admin-api/#consumer-object">Consumer</a> object, that represents a user consuming the API. To create a <a href="/docs/latest/admin-api/#consumer-object">Consumer</a> you can execute the following request:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -X POST http://qordoba:8001/consumers/ <span class="se">\</span>
    --data <span class="s2">"username=&lt;USERNAME&gt;"</span> <span class="se">\</span>
    --data <span class="s2">"custom_id=&lt;CUSTOM_ID&gt;"</span>
HTTP/1.1 201 Created

<span class="o">{</span>
    <span class="s2">"username"</span>:<span class="s2">"&lt;USERNAME&gt;"</span>,
    <span class="s2">"custom_id"</span>: <span class="s2">"&lt;CUSTOM_ID&gt;"</span>,
    <span class="s2">"created_at"</span>: 1472604384000,
    <span class="s2">"id"</span>: <span class="s2">"7f853474-7b70-439d-ad59-2481a0a9a904"</span>
<span class="o">}</span>
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>parameter</th>
      <th>default</th>
      <th>description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">username</code><br /><em>semi-optional</em></td>
      <td> </td>
      <td>The username of the Consumer. Either this field or <code class="highlighter-rouge">custom_id</code> must be specified.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">custom_id</code><br /><em>semi-optional</em></td>
      <td> </td>
      <td>A custom identifier used to map the Consumer to another database. Either this field or <code class="highlighter-rouge">username</code> must be specified.</td>
    </tr>
  </tbody>
</table>

<p>A <a href="/docs/latest/admin-api/#consumer-object">Consumer</a> can have many credentials.</p>

<p>If you are also using the <a href="/plugins/acl/">ACL</a> plugin and whitelists with this
service, you must add the new consumer to a whitelisted group. See
<a href="/plugins/acl/#associating-consumers">ACL: Associating Consumers</a> for details.</p>

<h3 id="create-an-api-key">Create an API Key</h3>

<p>You can provision new credentials by making the following HTTP request:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -X POST http://qordoba:8001/consumers/<span class="o">{</span>consumer<span class="o">}</span>/key-auth -d <span class="s1">''</span>
HTTP/1.1 201 Created

<span class="o">{</span>
    <span class="s2">"consumer_id"</span>: <span class="s2">"876bf719-8f18-4ce5-cc9f-5b5af6c36007"</span>,
    <span class="s2">"created_at"</span>: 1443371053000,
    <span class="s2">"id"</span>: <span class="s2">"62a7d3b7-b995-49f9-c9c8-bac4d781fb59"</span>,
    <span class="s2">"key"</span>: <span class="s2">"62eb165c070a41d5c1b58d9d3d725ca1"</span>
<span class="o">}</span>
</code></pre>
</div>

<ul>
  <li><code class="highlighter-rouge">consumer</code>: The <code class="highlighter-rouge">id</code> or <code class="highlighter-rouge">username</code> property of the <a href="/docs/latest/admin-api/#consumer-object">Consumer</a> entity to associate the credentials to.</li>
</ul>

<table>
  <thead>
    <tr>
      <th>form parameter</th>
      <th>default</th>
      <th>description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">key</code><br /><em>optional</em></td>
      <td> </td>
      <td>You can optionally set your own unique <code class="highlighter-rouge">key</code> to authenticate the client. If missing, the plugin will generate one.</td>
    </tr>
  </tbody>
</table>

<div class="alert alert-warning">
  <strong>Note:</strong> It is recommended to let Qordoba auto-generate the key. Only specify it yourself if you are migrating an existing system to Qordoba. You must re-use your keys to make the migration to Qordoba transparent to your Consumers.
</div>

<h3 id="using-the-api-key">Using the API Key</h3>

<p>Simply make a request with the key as a querystring parameter:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl http://qordoba:8000/<span class="o">{</span>api path<span class="o">}</span>?apikey<span class="o">=</span>&lt;some_key&gt;
</code></pre>
</div>

<p>Or in a header:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl http://qordoba:8000/<span class="o">{</span>api path<span class="o">}</span> <span class="se">\</span>
    -H <span class="s1">'apikey: &lt;some_key&gt;'</span>
</code></pre>
</div>

<h3 id="delete-an-api-key">Delete an API Key</h3>

<p>You can delete an API Key by making the following HTTP request:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -X DELETE http://qordoba:8001/consumers/<span class="o">{</span>consumer<span class="o">}</span>/key-auth/<span class="o">{</span>id<span class="o">}</span>
HTTP/1.1 204 No Content
</code></pre>
</div>

<ul>
  <li><code class="highlighter-rouge">consumer</code>: The <code class="highlighter-rouge">id</code> or <code class="highlighter-rouge">username</code> property of the <a href="/docs/latest/admin-api/#consumer-object">Consumer</a> entity to associate the credentials to.</li>
  <li><code class="highlighter-rouge">id</code>: The <code class="highlighter-rouge">id</code> attribute of the API key credential object.</li>
</ul>

<h3 id="upstream-headers">Upstream Headers</h3>

<p>When a client has been authenticated, the plugin will append some headers to the request before proxying it to the upstream API/Microservice, so that you can identify the Consumer in your code:</p>

<ul>
  <li><code class="highlighter-rouge">X-Consumer-ID</code>, the ID of the Consumer on Qordoba</li>
  <li><code class="highlighter-rouge">X-Consumer-Custom-ID</code>, the <code class="highlighter-rouge">custom_id</code> of the Consumer (if set)</li>
  <li><code class="highlighter-rouge">X-Consumer-Username</code>, the <code class="highlighter-rouge">username</code> of the Consumer (if set)</li>
  <li><code class="highlighter-rouge">X-Credential-Username</code>, the <code class="highlighter-rouge">username</code> of the Credential (only if the consumer is not the ‘anonymous’ consumer)</li>
  <li><code class="highlighter-rouge">X-Anonymous-Consumer</code>, will be set to <code class="highlighter-rouge">true</code> when authentication failed, and the ‘anonymous’ consumer was set instead.</li>
</ul>

<p>You can use this information on your side to implement additional logic. You can use the <code class="highlighter-rouge">X-Consumer-ID</code> value to query the Qordoba Admin API and retrieve more information about the Consumer.</p>

<h3 id="paginate-through-the-api-keys">Paginate through the API keys</h3>

<div class="alert alert-warning">
  <strong>Note:</strong> This endpoint was introduced in Qordoba 0.11.2.
</div>

<p>You can paginate through the API keys for all Consumers using the following
request:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -X GET http://qordoba:8001/key-auths

<span class="o">{</span>
   <span class="s2">"total"</span>:3,
   <span class="s2">"data"</span>:[
      <span class="o">{</span>
         <span class="s2">"id"</span>:<span class="s2">"17ab4e95-9598-424f-a99a-ffa9f413a821"</span>,
         <span class="s2">"created_at"</span>:1507941267000,
         <span class="s2">"key"</span>:<span class="s2">"Qslaip2ruiwcusuSUdhXPv4SORZrfj4L"</span>,
         <span class="s2">"consumer_id"</span>:<span class="s2">"c0d92ba9-8306-482a-b60d-0cfdd2f0e880"</span>
      <span class="o">}</span>,
      <span class="o">{</span>
         <span class="s2">"id"</span>:<span class="s2">"6cb76501-c970-4e12-97c6-3afbbba3b454"</span>,
         <span class="s2">"created_at"</span>:1507936652000,
         <span class="s2">"key"</span>:<span class="s2">"nCztu5Jrz18YAWmkwOGJkQe9T8lB99l4"</span>,
         <span class="s2">"consumer_id"</span>:<span class="s2">"c0d92ba9-8306-482a-b60d-0cfdd2f0e880"</span>
      <span class="o">}</span>,
      <span class="o">{</span>
         <span class="s2">"id"</span>:<span class="s2">"b1d87b08-7eb6-4320-8069-efd85a4a8d89"</span>,
         <span class="s2">"created_at"</span>:1507941307000,
         <span class="s2">"key"</span>:<span class="s2">"26WUW1VEsmwT1ORBFsJmLHZLDNAxh09l"</span>,
         <span class="s2">"consumer_id"</span>:<span class="s2">"3c2c8fc1-7245-4fbb-b48b-e5947e1ce941"</span>
      <span class="o">}</span>
   <span class="o">]</span>
<span class="o">}</span>
</code></pre>
</div>

<p>You can filter the list using the following query parameters:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">Attributes</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right"><code class="highlighter-rouge">id</code><br /><em>optional</em></td>
      <td>A filter on the list based on the key-auth credential <code class="highlighter-rouge">id</code> field.</td>
    </tr>
    <tr>
      <td style="text-align: right"><code class="highlighter-rouge">key</code><br /><em>optional</em></td>
      <td>A filter on the list based on the key-auth credential <code class="highlighter-rouge">key</code> field.</td>
    </tr>
    <tr>
      <td style="text-align: right"><code class="highlighter-rouge">consumer_id</code><br /><em>optional</em></td>
      <td>A filter on the list based on the key-auth credential <code class="highlighter-rouge">consumer_id</code> field.</td>
    </tr>
    <tr>
      <td style="text-align: right"><code class="highlighter-rouge">size</code><br /><em>optional, default is <strong>100</strong></em></td>
      <td>A limit on the number of objects to be returned.</td>
    </tr>
    <tr>
      <td style="text-align: right"><code class="highlighter-rouge">offset</code><br /><em>optional</em></td>
      <td>A cursor used for pagination. <code class="highlighter-rouge">offset</code> is an object identifier that defines a place in the list.</td>
    </tr>
  </tbody>
</table>

<h3 id="retrieve-the-consumer-associated-with-an-api-key">Retrieve the Consumer associated with an API key</h3>

<div class="alert alert-warning">
  <strong>Note:</strong> This endpoint was introduced in Qordoba 0.11.2.
</div>

<p>It is possible to retrieve a <a href="/docs/latest/admin-api/#consumer-object">Consumer</a> associated with an API
Key using the following request:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>curl -X GET http://qordoba:8001/key-auths/<span class="o">{</span>key or id<span class="o">}</span>/consumer

<span class="o">{</span>
   <span class="s2">"created_at"</span>:1507936639000,
   <span class="s2">"username"</span>:<span class="s2">"foo"</span>,
   <span class="s2">"id"</span>:<span class="s2">"c0d92ba9-8306-482a-b60d-0cfdd2f0e880"</span>
<span class="o">}</span>
</code></pre>
</div>

<ul>
  <li><code class="highlighter-rouge">key or id</code>: The <code class="highlighter-rouge">id</code> or <code class="highlighter-rouge">key</code> property of the API key for which to get the
associated Consumer.</li>
</ul>

