<p>Add HMAC Signature authentication to your APIs to establish the integrity of
incoming requests. The plugin will validate the digital signature sent in the
<code class="highlighter-rouge">Proxy-Authorization</code> or <code class="highlighter-rouge">Authorization</code> header (in this order). This plugin
implementation is based off the <a href="https://tools.ietf.org/html/draft-cavage-http-signatures">draft-cavage-http-signatures</a> draft
with a slightly different signature scheme.</p>

<hr />

<h2 id="configuration">Configuration</h2>

<p>Configuring the plugin is straightforward, you can add it on top of an
<a href="/docs/latest/admin-api/#api-object">API</a> by executing the following request on your Qordoba server:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -X POST http://qordoba:8001/apis/<span class="o">{</span>api<span class="o">}</span>/plugins <span class="se">\</span>
    --data <span class="s2">"name=hmac-auth"</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">api</code>: The <code class="highlighter-rouge">id</code> or <code class="highlighter-rouge">name</code> of the API that this plugin configuration will target</p>

<p>You can also apply it for every API using the <code class="highlighter-rouge">http://qordoba:8001/plugins/</code>
endpoint. Read the <a href="/docs/latest/admin-api/#add-plugin">Plugin Reference</a>
for more information.</p>

<p>form parameter                          | default | description
—                                     | — | —
<code class="highlighter-rouge">name</code>                                  | | The name of the plugin to use, in this case: <code class="highlighter-rouge">hmac-auth</code>
<code class="highlighter-rouge">config.hide_credentials</code><br /><em>optional</em> | <code class="highlighter-rouge">false</code> | A boolean value telling the plugin to hide the credential to the upstream API server. It will be removed by Qordoba before proxying the request
<code class="highlighter-rouge">config.clock_skew</code><br /><em>optional</em>       | <code class="highlighter-rouge">300</code> | <a href="https://tools.ietf.org/html/draft-cavage-http-signatures-00#section-3.4">Clock Skew</a> in seconds to prevent replay attacks.
<code class="highlighter-rouge">config.anonymous</code><br /><em>optional</em>        | <code class="highlighter-rouge">     | An optional string (consumer uuid) value to use as an "anonymous" consumer if authentication fails. If empty (default), the request will fail with an authentication failure `4xx`. Please note that this value must refer to the Consumer `id` attribute which is internal to Qordoba, and **not** its `custom_id`.
`config.validate_request_body`&lt;br&gt;*optional* | `false` | A boolean value telling the plugin to enable body validation
`config.enforce_headers`&lt;br&gt;*optional*  |</code> | A list of headers which the client should at least use for HTTP signature creation
<code class="highlighter-rouge">config.algorithms</code><br /><em>optional</em>       | <code class="highlighter-rouge">hmac-sha1</code>,<br /><code class="highlighter-rouge">hmac-sha256</code>,<br /><code class="highlighter-rouge">hmac-sha384</code>,<br /><code class="highlighter-rouge">hmac-sha512</code> | A list of HMAC digest algorithms which the user wants to support. Allowed values are <code class="highlighter-rouge">hmac-sha1</code>, <code class="highlighter-rouge">hmac-sha256</code>, <code class="highlighter-rouge">hmac-sha384</code>, and <code class="highlighter-rouge">hmac-sha512</code>
—-</p>

<h2 id="usage">Usage</h2>

<p>In order to use the plugin, you first need to create a Consumer to associate
one or more credentials to.</p>

<h3 id="create-a-consumer">Create a Consumer</h3>

<p>You need to associate a credential to an existing <a href="/docs/latest/admin-api/#consumer-object">Consumer</a>
object. To create a
<a href="/docs/latest/admin-api/#consumer-object">Consumer</a> you can execute the following request:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -d <span class="s2">"username=user123&amp;custom_id=SOME_CUSTOM_ID"</span> http://qordoba:8001/consumers/
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>parameter</th>
      <th>description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">username</code><br /><em>semi-optional</em></td>
      <td>The username of the consumer. Either this field or <code class="highlighter-rouge">custom_id</code> must be specified.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">custom_id</code><br /><em>semi-optional</em></td>
      <td>A custom identifier used to map the consumer to another database. Either this field or <code class="highlighter-rouge">username</code> must be specified.</td>
    </tr>
  </tbody>
</table>

<p>A <a href="/docs/latest/admin-api/#consumer-object">Consumer</a> can have many credentials.</p>

<h3 id="create-a-credential">Create a Credential</h3>

<p>You can provision new username/password credentials by making the following
HTTP request:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -X POST http://qordoba:8001/consumers/<span class="o">{</span>consumer<span class="o">}</span>/hmac-auth <span class="se">\</span>
    --data <span class="s2">"username=bob"</span> <span class="se">\</span>
    --data <span class="s2">"secret=secret456"</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">consumer</code>: The <code class="highlighter-rouge">id</code> or <code class="highlighter-rouge">username</code> property of the <a href="/docs/latest/admin-api/#consumer-object">Consumer</a>
entity to associate the credentials to.</p>

<table>
  <thead>
    <tr>
      <th>form parameter</th>
      <th>description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">username</code></td>
      <td>The username to use in the HMAC Signature verification.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">secret</code><br /><em>optional</em></td>
      <td>The secret to use in the HMAC Signature verification. Note that if this parameter isn’t provided, Qordoba will generate a value for you and send it as part of the response body.</td>
    </tr>
  </tbody>
</table>

<h3 id="signature-authentication-scheme">Signature Authentication Scheme</h3>

<p>The client is expected to send an <code class="highlighter-rouge">Authorization</code> or <code class="highlighter-rouge">Proxy-Authorization</code> header
with the following parameterization:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>credentials := "hmac" params
params := keyId "," algorithm ", " headers ", " signature
keyId := "username" "=" plain-string
algorithm := "algorithm" "=" DQUOTE (hmac-sha1|hmac-sha256|hmac-sha384|hmac-sha512) DQUOTE
headers := "headers" "=" plain-string
signature := "signature" "=" plain-string
plain-string   = DQUOTE *( %x20-21 / %x23-5B / %x5D-7E ) DQUOTE
</code></pre>
</div>

<h3 id="signature-parameters">Signature Parameters</h3>

<table>
  <thead>
    <tr>
      <th>parameter</th>
      <th>description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>username</td>
      <td>The <code class="highlighter-rouge">username</code> of the credential</td>
    </tr>
    <tr>
      <td>algorithm</td>
      <td>Digital signature algorithm used to create the signature</td>
    </tr>
    <tr>
      <td>headers</td>
      <td>List of HTTP header names, separated by a single space character, used to sign the request</td>
    </tr>
    <tr>
      <td>signature</td>
      <td><code class="highlighter-rouge">Base64</code> encoded digital signature generated by the client</td>
    </tr>
  </tbody>
</table>

<h3 id="signature-string-construction">Signature String Construction</h3>

<p>In order to generate the string that is signed with a key, the client
MUST take the values of each HTTP header specified by <code class="highlighter-rouge">headers</code> in
the order they appear.</p>

<ol>
  <li>
    <p>If the header name is not <code class="highlighter-rouge">request-line</code> then append the
  lowercased header name followed with an ASCII colon <code class="highlighter-rouge">:</code> and an
  ASCII space ` `.</p>
  </li>
  <li>
    <p>If the header name is <code class="highlighter-rouge">request-line</code> then append the HTTP
  request line, otherwise append the header value.</p>
  </li>
  <li>
    <p>If value is not the last value then append an ASCII newline <code class="highlighter-rouge">\n</code>.
  The string MUST NOT include a trailing ASCII newline.</p>
  </li>
</ol>

<h3 id="clock-skew">Clock Skew</h3>

<p>The HMAC Authentication plugin also implements a clock skew check as described
in the <a href="https://tools.ietf.org/html/draft-cavage-http-signatures-00#section-3.4">specification</a> to prevent replay attacks. By default,
a minimum lag of 300s in either direction (past/future) is allowed. Any request
with a higher or lower date value will be rejected. The length of the clock
skew can be edited through the plugin’s configuration by setting the
<code class="highlighter-rouge">clock_skew</code> property (<code class="highlighter-rouge">config.clock_skew</code> POST parameters).</p>

<p>The server and requesting client should be synchronized with NTP and a valid
date (using GMT format) should be sent with either the <code class="highlighter-rouge">X-Date</code> or <code class="highlighter-rouge">Date</code>
header.</p>

<h3 id="body-validation">Body Validation</h3>

<p>User can set <code class="highlighter-rouge">config.validate_request_body</code> as <code class="highlighter-rouge">true</code> to validate the request
body. If it’s enabled and if the client sends a <code class="highlighter-rouge">Digest</code> header in the request,
the plugin will calculate the <code class="highlighter-rouge">SHA-256</code> HMAC digest of the request body and
match it against the value of the <code class="highlighter-rouge">Digest</code> header. The Digest header needs to
be in following format:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Digest: SHA-256=base64(sha256(&lt;body&gt;))
</code></pre>
</div>

<p>Note: In order to create the digest of a request body, the plugin needs to
retain it in memory, which might cause pressure on the worker’s Lua VM when
dealing with large bodies (several MBs) or during high request concurrency.</p>

<h3 id="enforcing-headers">Enforcing Headers</h3>

<p><code class="highlighter-rouge">config.enforce_headers</code> can be used to enforce any of the headers to be part
of the signature creation. By default, the plugin doesn’t enforce which header
needs to be used for the signature creation. The minimum recommended data to
sign is the <code class="highlighter-rouge">request-line</code>, <code class="highlighter-rouge">host</code>, and <code class="highlighter-rouge">date</code>. A strong signature would
include all of the headers and a <code class="highlighter-rouge">digest</code> of the body.</p>

<h3 id="hmac-example">HMAC Example</h3>

<p><strong>Add an API</strong></p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>  <span class="nv">$ </span>curl -i -X POST http://localhost:8001/apis <span class="se">\</span>
      -d <span class="s2">"name=hmac-test"</span> <span class="se">\</span>
      -d <span class="s2">"hosts=hmac.com"</span> <span class="se">\</span>
      -d <span class="s2">"upstream_url=http://example.com"</span>
  HTTP/1.1 201 Created
  ...

</code></pre>
</div>

<p><strong>Enable plugin</strong></p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>  <span class="nv">$ </span>curl -i -X POST http://localhost:8001/apis/hmac-test/plugins <span class="se">\</span>
      -d <span class="s2">"name=hmac-auth"</span> <span class="se">\</span>
      -d <span class="s2">"config.enforce_headers=date, request-line"</span> <span class="se">\</span>
      -d <span class="s2">"config.algorithms=hmac-sha1, hmac-sha256"</span>
  HTTP/1.1 201 Created
  ...

</code></pre>
</div>

<p>Here we are enabling the <code class="highlighter-rouge">hmac-auth</code> plugin on API the <code class="highlighter-rouge">hmac-test</code>.
  <code class="highlighter-rouge">config.enforce_headers</code> is set to force the client to at least use <code class="highlighter-rouge">date</code>
  and <code class="highlighter-rouge">request-line</code> in the HTTP signature creation. Also we are setting the
  <code class="highlighter-rouge">config.algorithms</code> to force the client to only use <code class="highlighter-rouge">hmac-sha1</code> or
  <code class="highlighter-rouge">hmac-sha256</code> for hashing the signing string.</p>

<p><strong>Add a Consumer</strong></p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>  <span class="nv">$ </span>curl -i -X POST http://localhost:8001/consumers/ <span class="se">\</span>
      -d <span class="s2">"username=alice"</span>
  HTTP/1.1 201 Created
  ...

</code></pre>
</div>

<p><strong>Add credential for Alice</strong></p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>  <span class="nv">$ </span>curl -i -X POST http://localhost:8001/consumers/alice/hmac-auth <span class="se">\</span>
      -d <span class="s2">"username=alice123"</span> <span class="se">\</span>
      -d <span class="s2">"secret=secret"</span>
  HTTP/1.1 201 Created
  ...

</code></pre>
</div>

<p><strong>Request to the API</strong></p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>  <span class="nv">$ </span>curl -i -X GET http://localhost:8000/requests <span class="se">\</span>
      -H <span class="s2">"Host: hmac.com"</span> <span class="se">\</span>
      -H <span class="s2">"Date: Thu, 22 Jun 2017 17:15:21 GMT"</span> <span class="se">\</span>
      -H <span class="s1">'Authorization: hmac username="alice123", algorithm="hmac-sha256", headers="date request-line", signature="ujWCGHeec9Xd6UD2zlyxiNMCiXnDOWeVFMu5VeRUxtw="'</span>
  HTTP/1.1 200 OK
  ...

</code></pre>
</div>

<p>In the above request, we are composing the signing string using the <code class="highlighter-rouge">date</code> and
  <code class="highlighter-rouge">request-line</code> headers and creating the digest using the <code class="highlighter-rouge">hmac-sha256</code> to
  hash the digest:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  signing_string="date: Thu, 22 Jun 2017 17:15:21 GMT\nGET /requests HTTP/1.1"
  digest=HMAC-SHA256(&lt;signing_string&gt;, "secret")
  base64_digest=base64(&lt;digest&gt;)
</code></pre>
</div>

<p>So the final value of the <code class="highlighter-rouge">Authorization</code> header would look like:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  Authorization: hmac username="alice123", algorithm="hmac-sha256", headers="date request-line", signature=&lt;base64_digest&gt;"
</code></pre>
</div>

<p><strong>Validating request body</strong></p>

<p>To enable body validation we would need to set <code class="highlighter-rouge">config.validate_request_body</code>
  to <code class="highlighter-rouge">true</code>:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>  <span class="nv">$ </span>curl -i -X PATCH http://localhost:8001/apis/hmac-test/plugins/:plugin_id <span class="se">\</span>
      -d <span class="s2">"config.validate_request_body=true"</span>
  HTTP/1.1 200 OK
  ...

</code></pre>
</div>

<p>Now if the client includes the body digest in the request as the value of the
  <code class="highlighter-rouge">Digest</code> header, the plugin will validate the request body by calculating the
  <code class="highlighter-rouge">SHA-256</code> of the body and matching it against the <code class="highlighter-rouge">Digest</code> header’s value.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>  <span class="nv">$ </span>curl -i -X GET http://localhost:8000/requests <span class="se">\</span>
      -H <span class="s2">"Host: hmac.com"</span> <span class="se">\</span>
      -H <span class="s2">"Date: Thu, 22 Jun 2017 21:12:36 GMT"</span> <span class="se">\</span>
      -H <span class="s2">"Digest: SHA-256=SBH7QEtqnYUpEcIhDbmStNd1MxtHg2+feBfWc1105MA="</span> <span class="se">\</span>
      -H <span class="s1">'Authorization: hmac username="alice123", algorithm="hmac-sha256", headers="date request-line digest", signature="gaweQbATuaGmLrUr3HE0DzU1keWGCt3H96M28sSHTG8="'</span> <span class="se">\</span>
      -d <span class="s2">"A small body"</span>
  HTTP/1.1 200 OK
  ...

</code></pre>
</div>

<p>In the above request we calculated the <code class="highlighter-rouge">SHA-256</code> digest of the body and set
  the <code class="highlighter-rouge">Digest</code> header with the following format:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  body="A small body"
  digest=SHA-256(body)
  base64_digest=base64(digest)
  Digest: SHA-256=&lt;base64_digest&gt;
</code></pre>
</div>

<h3 id="upstream-headers">Upstream Headers</h3>

<p>When a client has been authenticated, the plugin will append some headers to
the request before proxying it to the upstream API/Microservice, so that you
can identify the Consumer in your code:</p>

<ul>
  <li><code class="highlighter-rouge">X-Consumer-ID</code>, the ID of the Consumer on Qordoba</li>
  <li><code class="highlighter-rouge">X-Consumer-Custom-ID</code>, the <code class="highlighter-rouge">custom_id</code> of the Consumer (if set)</li>
  <li><code class="highlighter-rouge">X-Consumer-Username</code>, the <code class="highlighter-rouge">username</code> of the Consumer (if set)</li>
  <li><code class="highlighter-rouge">X-Credential-Username</code>, the <code class="highlighter-rouge">username</code> of the Credential (only if the consumer is not the ‘anonymous’ consumer)</li>
  <li><code class="highlighter-rouge">X-Anonymous-Consumer</code>, will be set to <code class="highlighter-rouge">true</code> when authentication failed, and the ‘anonymous’ consumer was set instead.</li>
</ul>

<p>You can use this information on your side to implement additional logic.
You can use the <code class="highlighter-rouge">X-Consumer-ID</code> value to query the Qordoba Admin API and retrieve
more information about the Consumer.</p>

<h3 id="paginate-through-the-hmac-credentials">Paginate through the HMAC Credentials</h3>

<div class="alert alert-warning">
  <strong>Note:</strong> This endpoint was introduced in Qordoba 0.11.2.
</div>

<p>You can paginate through the hmac-auth Credentials for all Consumers using the
following request:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -X GET http://qordoba:8001/hmac-auths

<span class="o">{</span>
    <span class="s2">"total"</span>: 3,
    <span class="s2">"data"</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">"created_at"</span>: 1509681246000,
            <span class="s2">"id"</span>: <span class="s2">"75695322-e8a0-4109-aed4-5416b0308d85"</span>,
            <span class="s2">"secret"</span>: <span class="s2">"wQazJ304DW5huJklHgUfjfiSyCyTAEDZ"</span>,
            <span class="s2">"username"</span>: <span class="s2">"foo"</span>,
            <span class="s2">"consumer_id"</span>: <span class="s2">"c0d92ba9-8306-482a-b60d-0cfdd2f0e880"</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">"created_at"</span>: 1509419793000,
            <span class="s2">"id"</span>: <span class="s2">"11d5cbfb-31b9-4a6d-8496-2f4a76500643"</span>,
            <span class="s2">"secret"</span>: <span class="s2">"zi6YHyvLaUCe21XMXKesTYiHSWy6m6CW"</span>,
            <span class="s2">"username"</span>: <span class="s2">"bar"</span>,
            <span class="s2">"consumer_id"</span>: <span class="s2">"3c2c8fc1-7245-4fbb-b48b-e5947e1ce941"</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">"created_at"</span>: 1509681215000,
            <span class="s2">"id"</span>: <span class="s2">"eb0365bc-88ae-4568-be7c-db1eb7c16e5e"</span>,
            <span class="s2">"secret"</span>: <span class="s2">"NvHDTg5mp0ySFVJsITurtgyhEq1Cxbnv"</span>,
            <span class="s2">"username"</span>: <span class="s2">"baz"</span>,
            <span class="s2">"consumer_id"</span>: <span class="s2">"c0d92ba9-8306-482a-b60d-0cfdd2f0e880"</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>
</code></pre>
</div>

<p>You can filter the list using the following query parameters:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">Attributes</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right"><code class="highlighter-rouge">id</code><br /><em>optional</em></td>
      <td>A filter on the list based on the hmac-auth credential <code class="highlighter-rouge">id</code> field.</td>
    </tr>
    <tr>
      <td style="text-align: right"><code class="highlighter-rouge">username</code><br /><em>optional</em></td>
      <td>A filter on the list based on the hmac-auth credential <code class="highlighter-rouge">username</code> field.</td>
    </tr>
    <tr>
      <td style="text-align: right"><code class="highlighter-rouge">consumer_id</code><br /><em>optional</em></td>
      <td>A filter on the list based on the hmac-auth credential <code class="highlighter-rouge">consumer_id</code> field.</td>
    </tr>
    <tr>
      <td style="text-align: right"><code class="highlighter-rouge">size</code><br /><em>optional, default is <strong>100</strong></em></td>
      <td>A limit on the number of objects to be returned.</td>
    </tr>
    <tr>
      <td style="text-align: right"><code class="highlighter-rouge">offset</code><br /><em>optional</em></td>
      <td>A cursor used for pagination. <code class="highlighter-rouge">offset</code> is an object identifier that defines a place in the list.</td>
    </tr>
  </tbody>
</table>

<h3 id="retrieve-the-consumer-associated-with-a-credential">Retrieve the Consumer associated with a Credential</h3>

<div class="alert alert-warning">
  <strong>Note:</strong> This endpoint was introduced in Qordoba 0.11.2.
</div>

<p>It is possible to retrieve a <a href="/docs/latest/admin-api/#consumer-object">Consumer</a> associated with an
HMAC Credential using the following request:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>curl -X GET http://qordoba:8001/hmac-auths/<span class="o">{</span>hmac username or id<span class="o">}</span>/consumer

<span class="o">{</span>
   <span class="s2">"created_at"</span>:1507936639000,
   <span class="s2">"username"</span>:<span class="s2">"foo"</span>,
   <span class="s2">"id"</span>:<span class="s2">"c0d92ba9-8306-482a-b60d-0cfdd2f0e880"</span>
<span class="o">}</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">hmac username or id</code>: The <code class="highlighter-rouge">id</code> or <code class="highlighter-rouge">username</code> property of the HMAC Credential
for which to get the associated <a href="/docs/latest/admin-api/#consumer-object">Consumer</a>.
Note that <code class="highlighter-rouge">username</code> accepted here is <strong>not</strong> the <code class="highlighter-rouge">username</code> property of a
Consumer.</p>

